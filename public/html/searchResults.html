<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="http://my.maerskline.com/public/10_0_205/thirdparty.min.css" type="text/css" rel="stylesheet"/>
    <link href="http://my.maerskline.com/public/10_0_205/maersk.min.css" type="text/css" rel="stylesheet"/>
    <link href="../css/theme.css" type="text/css" rel="stylesheet"/>
</head>
<body>

<div id="searchCriteria"></div>
<div id="results"></div>

<script type="text/javascript" src="../js/lib/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../js/lib/handlebars-v4.0.2.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        var searchData = {
            fields : {
            },
            build : function(){
                this.setField("country");
                this.setField("city");
                this.setField("company");
                this.setField("customerLegalName");
                this.setField("customerTradingName");
                this.setField("lifecycleStatus");
                this.setField("house");
                this.setField("street");
                this.setField("region");
                this.setField("pobox");
                this.setField("postalCode");
            },
            setField : function(fieldName){
                var paramValue = this.getParameterByName(fieldName);
                if(this.checkValueNotBlank(paramValue)){
                    this.fields[fieldName] = paramValue;
                }
            },
            getParameterByName : function(name) {
                name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
                var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                        results = regex.exec(location.search);
                return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
            },
            checkValueNotBlank : function(value){
                return value != "" ? true : false;
            }
        };

        searchData.build();

        compileAndInjectContent("#searchCriteria-template", searchData, "#searchCriteria");

        getResults(searchData.fields);
    });

    function getResults(searchFields){

        var templateData = {
            "zeroResults" : false,
            "tooManyResults" : false,
            "finalPage" : false
        };

        var TOO_MANY_RESULTS = "CMDWS-401";
        var NO_DATA_FOUND = "CMDWS-501";

        $.ajax({
            url : "http://uicmd1.tst.ml.apmoller.net:16010/md/customer/rest/customers",
            type : "GET",
            data : searchFields,
            success : function(data) {

                if(data.numberOfRecords == 0){
                    templateData.zeroResults = true;
                } else if(data.responseWarning.code == TOO_MANY_RESULTS){
                    templateData.tooManyResults = true;
                    templateData.results = data.customerSummaries;
                    templateData.resultCount = data.numberOfRecords;
                } else {
                    templateData.results = data.customerSummaries;
                    templateData.resultCount = data.numberOfRecords;
                }

                compileAndInjectContent("#results-template", templateData, "#results");
            }

        });
    }

    function compileAndInjectContent(templateId, context, target){
        var source   = $(templateId).html();
        var template = Handlebars.compile(source);
        var html = template(context);
        $(target).html(html);
    }
</script>
<script id="searchCriteria-template" type="text/x-handlebars-template">
    <h1>Search Results</h1>
    <h3>you searched for
        {{#each fields}}
        <!--{{@key}}: {{this}}-->
        {{#if this}}
        <strong>&quot;{{this}}&quot;</strong>,
        {{/if}}
        {{/each}}
    </h3>
    <p>Return and search again</p>
</script>
<script id="results-template" type="text/x-handlebars-template">

    {{#if zeroResults}}
        <div>No results found</div>
        <button>Create a new record</button>
        <button>Return and search again</button>

    {{else}}
        {{#if tooManyResults}}
            <div>more than {{resultCount}} results found</div>
            <button>Return and narrow your search</button>
        {{else}}
            <div>{{resultCount}} results found</div>
        {{/if}}
        <div>Not found what you need? Create a new record</div>

        {{#results}}
            <div>
                <div>Trading name {{customerTradingName}}</div>
                <div>Customer code {{customerCode}}</div>
            </div>
        {{/results}}

        {{#if tooManyResults}}
            {{#if finalPage}}
                <div>
                    <p>30 is the most number of results we can return</p>
                    <button>Return and narrow your search</button>
                    <p>Or if you have it, try searching by unique customer code</p>
                    <input type="text" name="unc" id="unc"/> <button>search</button>
                    <div>Still not found what you need? Create a new record</div>
                </div>
            {{/if}}
        {{/if}}
    {{/if}}
</script>
</body>
</html>